<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FischIs Telemetry Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">FischIs Telemetry</h1>
    <div id="root"></div>
  </div>

  <script type="text/babel">
    const { useEffect, useState } = React;

    function useApi(url, intervalMs = 5000) {
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      async function load() {
        try {
          const res = await fetch(url);
          const json = await res.json();
          setData(Array.isArray(json) ? json : []);
          setError(null);
        } catch (e) {
          setError(e?.message || 'Failed to load');
        } finally {
          setLoading(false);
        }
      }
      useEffect(() => {
        load();
        const id = setInterval(load, intervalMs);
        return () => clearInterval(id);
      }, [url, intervalMs]);
      return { data, loading, error };
    }

    function RodsBadge({ item }) {
      const has = (f) => Boolean(item && item[f]);
      const text = item?.rodsDisplay || (Array.isArray(item?.rods) ? String(item.rods.length) : '0');
      const mode = item?.rodsDisplayMode || (Array.isArray(item?.rods) ? 'count' : 'text');
      const isText = mode === 'text';
      const cls = isText ? 'text-amber-600 font-semibold' : 'text-slate-900 font-bold';
      return (
        <div className="text-right">
          <div className={cls}>{text}</div>
          <div className="text-xs text-slate-500 mt-0.5">Rods</div>
        </div>
      );
    }

    function AccountCard({ item }) {
      const name = item.displayName || item.playerName || item.account || 'Unknown';
      const location = item.location || 'Unknown';
      const level = item.level ?? 0;
      return (
        <div className="rounded-xl border bg-white shadow-sm">
          <div className="flex items-center justify-between p-4">
            <div>
              <div className="text-sm text-slate-600">{name}</div>
              <div className="text-xs text-slate-500 mt-0.5">{location} • Lv {level}</div>
            </div>
            <RodsBadge item={item} />
          </div>
        </div>
      );
    }

    function App() {
      const { data, loading, error } = useApi('http://localhost:3001/api/data');
      if (loading) return <div className="text-slate-500">Loading…</div>;
      if (error) return <div className="text-red-600">{String(error)}</div>;
      return (
        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {data.map((item, idx) => (
            <AccountCard key={item.account || idx} item={item} />
          ))}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
